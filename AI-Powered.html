<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecureID Pro - AI Document Masking</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/4.1.1/tesseract.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --electric-blue: #1E90FF;
            --gold: #FFD700;
            --gold-secondary: #FFC300;
            --teal-blue: #007B8A;
            --cyan: #00BCD4;
            --deep-purple: #4B0082;
            --navy-blue: #1F2F46;
            --dark-charcoal: #1A1A1A;
            --jet-black: #121212;
            --platinum-white: #F8F8FF;

            --text-main: var(--platinum-white);
            --text-accent: var(--gold);
            --background-main: var(--navy-blue);
            --background-dark: var(--dark-charcoal);
            --button-bg: var(--electric-blue);
            --button-hover: var(--gold);
            --accent: var(--teal-blue);
        }

        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        @keyframes slideIn { from { transform: translateX(-100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .floating { animation: float 3s ease-in-out infinite; }
        .pulsing { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        .slide-in { animation: slideIn 0.5s ease-out; }
        .spinning { animation: spin 1s linear infinite; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }

        .btn-3d { 
            position: relative; 
            transition: all 0.3s ease; 
            box-shadow: 0 5px 0 0 rgba(0,0,0,0.2); 
        }
        .btn-3d:active { 
            transform: translateY(5px); 
            box-shadow: 0 2px 0 0 rgba(0,0,0,0.2); 
        }
        .btn-3d:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 0 0 rgba(0,0,0,0.2);
        }

        .progress-bar { 
            height: 6px; 
            background: linear-gradient(90deg, var(--electric-blue), var(--deep-purple), var(--teal-blue)); 
            transition: width 0.3s ease; 
            border-radius: 3px; 
        }

        .document-preview { 
            transition: all 0.3s ease; 
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); 
        }
        .document-preview:hover { 
            transform: scale(1.02); 
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); 
        }

        .mask-overlay { 
            position: absolute; 
            border: 2px dashed rgba(255, 255, 255, 0.8); 
            backdrop-filter: blur(0px); 
            transition: all 0.3s ease; 
            cursor: move; 
        }
        .mask-black { background-color: rgba(0, 0, 0, 0.9); }
        .mask-blur { backdrop-filter: blur(10px); background: rgba(0, 0, 0, 0.3); }
        .mask-pixelate { background: repeating-conic-gradient(#000 0% 25%, transparent 0% 50%) 50% / 8px 8px; }
        .mask-character { 
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            font-family: monospace;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .glass-effect { 
            backdrop-filter: blur(10px); 
            background: rgba(255, 255, 255, 0.1); 
            border: 1px solid rgba(255, 255, 255, 0.2); 
        }
        .neon-border { 
            box-shadow: 0 0 5px rgba(30, 144, 255, 0.5), 0 0 20px rgba(30, 144, 255, 0.3), 0 0 35px rgba(30, 144, 255, 0.1); 
        }
        .detection-highlight { 
            border: 3px solid var(--teal-blue); 
            box-shadow: 0 0 10px rgba(0, 123, 138, 0.5); 
            animation: pulse 2s infinite; 
        }

        #threejs-background { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            z-index: -1; 
            opacity: 0.2; 
        }
        .sidebar { 
            background: var(--dark-charcoal); 
            border-right: 1px solid var(--teal-blue); 
        }
        .badge { 
            background: var(--gold); 
            color: var(--jet-black); 
        }
        body { 
            background: var(--background-dark); 
            color: var(--text-main); 
        }
        .bg-gradient-to-br { 
            background-image: linear-gradient(to bottom right, var(--background-dark), var(--background-main)); 
        }
        .text-accent { color: var(--text-accent); }
        .bg-accent { background-color: var(--accent); }
        .btn-primary { background-color: var(--button-bg); color: white; }
        .btn-primary:hover { background-color: var(--button-hover); }

        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 20px 40px rgba(30, 144, 255, 0.2); 
        }

        .detection-box { 
            position: absolute; 
            border: 3px solid #00ff00; 
            background: rgba(0, 255, 0, 0.1); 
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .detection-box:hover { 
            background: rgba(0, 255, 0, 0.2); 
            transform: scale(1.02);
        }
        .detection-label {
            position: absolute;
            top: -25px;
            left: 0;
            background: rgba(0, 0, 0, 0.8);
            color: #00ff00;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .processing-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .session-history-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .session-history-item:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--electric-blue);
            transform: translateY(-2px);
        }
        .session-history-item.selected {
            border-color: var(--gold);
            background: rgba(255, 215, 0, 0.1);
        }

        .tab-button {
            padding: 12px 24px;
            border-radius: 8px 8px 0 0;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .tab-button.active {
            background: var(--electric-blue);
            border-color: var(--electric-blue);
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, var(--electric-blue), var(--teal-blue));
            color: white;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            z-index: 1001;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            float: right;
            margin-left: 10px;
        }

        .tooltip {
            position: relative;
            display: inline-block;
        }
        
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 140px;
            background-color: rgba(0, 0, 0, 0.9);
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 150%;
            left: 50%;
            margin-left: -70px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
        }
        
        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: rgba(0, 0, 0, 0.9) transparent transparent transparent;
        }
        
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        /* Character format coding styles */
        .character-format-container {
            display: none;
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }
        
        .character-format-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .character-format-option {
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            transition: all 0.2s;
        }
        
        .character-format-option:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .character-format-option.selected {
            background: var(--electric-blue);
            color: white;
        }
        
        .character-preview {
            font-family: monospace;
            font-size: 24px;
            text-align: center;
            margin: 15px 0;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
        }
        
        /* Results page specific styles */
        .results-page {
            display: none;
        }
        
        .metadata-display {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .metadata-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 15px;
        }
        
        .metadata-card h4 {
            font-size: 18px;
            margin-bottom: 10px;
            color: var(--gold);
        }
        
        .metadata-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .metadata-label {
            color: var(--platinum-white);
            opacity: 0.8;
        }
        
        .metadata-value {
            color: white;
            font-weight: 500;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br">
    <div id="threejs-background"></div>

    <div id="app" class="relative z-10">
        <!-- Main Application View -->
        <div id="mainAppView">
            <header class="glass-effect shadow-2xl border-b border-white/10">
                <div class="container mx-auto px-4 py-6">
                    <div class="flex flex-col md:flex-row justify-between items-center">
                        <div class="flex items-center mb-4 md:mb-0">
                            <i class="fas fa-shield-halved text-4xl mr-3 floating text-accent"></i>
                            <div>
                                <h1 class="text-3xl md:text-4xl font-bold bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent">
                                    SecureID Pro
                                </h1>
                                <p class="text-sm" style="color: var(--text-main);">Advanced ID & Person Detection Masking</p>
                            </div>
                        </div>
                        <nav class="flex space-x-6">
                            <a href="#" class="px-4 py-2 rounded-lg glass-effect hover:bg-white/20 transition flex items-center">
                                <i class="fas fa-home mr-2"></i>Home
                            </a>
                            <a href="#upload" class="px-4 py-2 rounded-lg glass-effect hover:bg-white/20 transition flex items-center">
                                <i class="fas fa-upload mr-2"></i>Upload
                            </a>
                            <a href="#" id="resultsTabBtn" class="px-4 py-2 rounded-lg glass-effect hover:bg-white/20 transition flex items-center">
                                <i class="fas fa-check-circle mr-2"></i>Results
                            </a>
                            <a href="#" id="historyTab" class="px-4 py-2 rounded-lg glass-effect hover:bg-white/20 transition flex items-center">
                                <i class="fas fa-history mr-2"></i>History
                            </a>
                        </nav>
                    </div>
                </div>
            </header>

            <main class="container mx-auto px-4 py-8 flex">
                <div class="sidebar w-64 hidden md:block mr-8 rounded-lg p-4 glass-effect">
                    <h3 class="text-lg font-bold mb-4 text-accent">Detection Options</h3>
                    <ul class="space-y-3">
                        <li>
                            <label class="flex items-center">
                                <input type="checkbox" id="detectAadhaar" checked class="mr-3">
                                <span>Aadhaar Numbers</span>
                            </label>
                        </li>
                        <li>
                            <label class="flex items-center">
                                <input type="checkbox" id="detectPAN" checked class="mr-3">
                                <span>PAN Card Numbers</span>
                            </label>
                        </li>
                        <li>
                            <label class="flex items-center">
                                <input type="checkbox" id="detectLicense" checked class="mr-3">
                                <span>License Numbers</span>
                            </label>
                        </li>
                        <li>
                            <label class="flex items-center">
                                <input type="checkbox" id="detectPerson" checked class="mr-3">
                                <span>Person/Face Detection</span>
                            </label>
                        </li>
                        <li>
                            <label class="flex items-center">
                                <input type="checkbox" id="detectPhone" checked class="mr-3">
                                <span>Phone Numbers</span>
                            </label>
                        </li>
                        <li>
                            <label class="flex items-center">
                                <input type="checkbox" id="detectEmail" checked class="mr-3">
                                <span>Email Addresses</span>
                            </label>
                        </li>
                    </ul>
                    
                    <h3 class="text-lg font-bold mb-4 mt-6 text-accent">Mask Settings</h3>
                    <div class="space-y-3">
                        <label class="flex items-center">
                            <input type="radio" name="maskType" value="black" checked class="mr-3">
                            <span>Black Rectangle</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="maskType" value="blur" class="mr-3">
                            <span>Gaussian Blur</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="maskType" value="pixelate" class="mr-3">
                            <span>Pixelation</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="maskType" value="character" class="mr-3">
                            <span>Character Format</span>
                        </label>
                    </div>

                    <!-- Character Format Options -->
                    <div id="characterFormatContainer" class="character-format-container">
                        <h4 class="text-md font-bold mb-3 text-accent">Character Style</h4>
                        <div class="character-format-options">
                            <div class="character-format-option" data-style="asterisk">*****</div>
                            <div class="character-format-option" data-style="hash">#####</div>
                            <div class="character-format-option" data-style="x">XXXXX</div>
                            <div class="character-format-option" data-style="random">R@ND0M</div>
                            <div class="character-format-option" data-style="dots">•••••</div>
                            <div class="character-format-option" data-style="custom">Custom</div>
                        </div>
                        
                        <div id="customCharacterInput" class="mt-3 hidden">
                            <label class="block text-sm mb-2">Custom Characters:</label>
                            <input type="text" id="customCharacters" class="w-full bg-gray-700 rounded p-2" placeholder="Enter custom pattern">
                        </div>
                        
                        <div class="character-preview" id="characterPreview">
                            Sample Text
                        </div>
                    </div>

                    <!-- Session History Section -->
                    <div class="mt-8">
                        <h3 class="text-lg font-bold mb-4 text-accent flex items-center">
                            <i class="fas fa-history mr-2"></i>Recent Sessions
                        </h3>
                        <div id="sessionHistory" class="max-h-64 overflow-y-auto">
                            <!-- Session history items will be populated here -->
                        </div>
                        <button id="clearHistoryBtn" class="btn-3d bg-red-500 text-white px-3 py-2 rounded-lg text-xs mt-2 w-full">
                            <i class="fas fa-trash mr-1"></i>Clear History
                        </button>
                    </div>
                </div>

                <div class="flex-1">
                    <div class="text-center mb-12">
                        <h2 class="text-5xl font-bold mb-4 bg-gradient-to-r from-blue-400 via-purple-400 to-pink-400 bg-clip-text text-transparent">
                            AI-Powered ID & Person Detection
                        </h2>
                        <p class="text-xl max-w-3xl mx-auto leading-relaxed" style="color: var(--text-main);">
                            Upload your document or continue from a previous session to detect and mask sensitive information automatically.
                        </p>
                    </div>

                    <!-- Upload Tabs -->
                    <div class="mb-6">
                        <div class="flex space-x-2">
                            <button id="newUploadTab" class="tab-button active">
                                <i class="fas fa-upload mr-2"></i>New Upload
                            </button>
                            <button id="continueSessionTab" class="tab-button">
                                <i class="fas fa-history mr-2"></i>Continue Session
                            </button>
                        </div>
                    </div>

                    <!-- New Upload Tab Content -->
                    <div id="newUploadContent" class="tab-content active">
                        <!-- File Upload Section -->
                        <div id="upload" class="glass-effect rounded-2xl p-6 mb-8 neon-border">
                            <h3 class="text-2xl font-bold mb-4 flex items-center">
                                <i class="fas fa-cloud-upload-alt text-blue-400 mr-3"></i>
                                Upload Document
                            </h3>
                            <div class="border-2 border-dashed border-gray-400 rounded-lg p-8 text-center">
                                <input type="file" id="fileInput" accept="image/*" class="hidden">
                                <div id="uploadArea" class="cursor-pointer">
                                    <i class="fas fa-upload text-6xl text-gray-400 mb-4"></i>
                                    <p class="text-xl mb-2">Click to upload or drag and drop</p>
                                    <p class="text-gray-400">Supports: JPG, PNG, PDF, TIFF</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Continue Session Tab Content -->
                    <div id="continueSessionContent" class="tab-content">
                        <div class="glass-effect rounded-2xl p-6 mb-8 neon-border">
                            <h3 class="text-2xl font-bold mb-4 flex items-center">
                                <i class="fas fa-history text-blue-400 mr-3"></i>
                                Continue Previous Session
                            </h3>
                            <div id="sessionSelector" class="space-y-4">
                                <div class="text-center py-8 text-gray-400" id="noSessionsMessage">
                                    <i class="fas fa-clock text-4xl mb-4"></i>
                                    <p>No previous sessions found</p>
                                    <p class="text-sm">Upload and process an image to create your first session</p>
                                </div>
                            </div>
                            <div class="mt-6 flex justify-center">
                                <button id="loadSessionBtn" class="btn-3d btn-primary px-8 py-3 rounded-lg font-medium text-lg hidden">
                                    <i class="fas fa-play mr-2"></i>Load Selected Session
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Image Preview Section -->
                    <div id="previewSection" class="glass-effect rounded-2xl p-6 mb-8 neon-border hidden">
                        <h3 class="text-2xl font-bold mb-4 flex items-center">
                            <i class="fas fa-eye text-blue-400 mr-3"></i>
                            Document Preview & Detection
                            <span id="sessionIndicator" class="ml-4 px-3 py-1 text-xs bg-yellow-500 text-black rounded-full hidden">
                                <i class="fas fa-history mr-1"></i>Continued Session
                            </span>
                        </h3>
                        <div class="document-preview glass-effect rounded-lg overflow-hidden relative">
                            <canvas id="imageCanvas" class="w-full h-auto max-h-96 object-contain"></canvas>
                            <div id="detectionOverlay" class="absolute inset-0 pointer-events-none"></div>
                        </div>
                        <div class="mt-6 flex justify-center gap-4">
                            <button id="processBtn" class="btn-3d btn-primary px-8 py-3 rounded-lg font-medium text-lg">
                                <i class="fas fa-search mr-2"></i>Detect & Analyze
                            </button>
                            <button id="applyMaskBtn" class="btn-3d bg-green-500 px-8 py-3 rounded-lg font-medium text-lg hidden">
                                <i class="fas fa-mask mr-2"></i>Apply Masks
                            </button>
                            <button id="saveSessionBtn" class="btn-3d bg-purple-500 px-8 py-3 rounded-lg font-medium text-lg hidden">
                                <i class="fas fa-save mr-2"></i>Save Session
                            </button>
                        </div>
                    </div>

                    <!-- Detection Results -->
                    <div id="resultsSection" class="glass-effect rounded-xl p-6 mb-8 hidden">
                        <h3 class="text-xl font-bold mb-4 flex items-center">
                            <i class="fas fa-list-check text-green-400 mr-3"></i>
                            Detection Results
                        </h3>
                        <div id="detectionResults" class="space-y-2">
                            <!-- Results will be populated here -->
                        </div>
                    </div>

                    <!-- Download Section -->
                    <div class="flex justify-center gap-4">
                        <button id="downloadBtn" class="btn-3d bg-gradient-to-r from-green-500 to-teal-500 text-white px-6 py-3 rounded-lg font-medium flex items-center hidden">
                            <i class="fas fa-download mr-2"></i>Download Masked Image
                        </button>
                        <button id="resetBtn" class="btn-3d bg-gray-500 text-white px-6 py-3 rounded-lg font-medium flex items-center">
                            <i class="fas fa-refresh mr-2"></i>Reset
                        </button>
                    </div>
                </div>
            </main>
        </div>

        <!-- Results Page View -->
        <div id="resultsPageView" class="results-page">
            <header class="glass-effect shadow-2xl border-b border-white/10">
                <div class="container mx-auto px-4 py-6">
                    <div class="flex flex-col md:flex-row justify-between items-center">
                        <div class="flex items-center mb-4 md:mb-0">
                            <i class="fas fa-shield-halved text-4xl mr-3 floating text-accent"></i>
                            <div>
                                <h1 class="text-3xl md:text-4xl font-bold bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent">
                                    SecureID Pro
                                </h1>
                                <p class="text-sm" style="color: var(--text-main);">AI-Powered Document Masking Results</p>
                            </div>
                        </div>
                        <nav class="flex space-x-6">
                            <a href="#" id="backToAppBtn" class="px-4 py-2 rounded-lg glass-effect hover:bg-white/20 transition flex items-center">
                                <i class="fas fa-arrow-left mr-2"></i>Back
                            </a>
                        </nav>
                    </div>
                </div>
            </header>

            <main class="container mx-auto px-4 py-8">
                <div class="glass-effect rounded-2xl p-6 mb-8">
                    <h3 class="text-2xl font-bold mb-4 flex items-center">
                        <i class="fas fa-check-circle text-green-400 mr-3"></i>
                        Your Secured Document
                    </h3>
                    
                    <div class="document-preview glass-effect rounded-lg overflow-hidden relative">
                        <canvas id="resultsCanvas" class="w-full h-auto max-h-screen object-contain"></canvas>
                    </div>
                    
                    <div class="metadata-display" id="metadataDisplay">
                        <!-- Metadata will be displayed here -->
                    </div>
                </div>
                
                <div class="flex justify-center gap-4">
                    <button id="resultsDownloadBtn" class="btn-3d bg-gradient-to-r from-green-500 to-teal-500 text-white px-6 py-3 rounded-lg font-medium flex items-center">
                        <i class="fas fa-download mr-2"></i>Download Secured Image
                    </button>
                    <button id="newDocumentBtn" class="btn-3d bg-gradient-to-r from-blue-500 to-purple-500 text-white px-6 py-3 rounded-lg font-medium flex items-center">
                        <i class="fas fa-redo mr-2"></i>Process Another
                    </button>
                </div>
            </main>
        </div>

        <footer class="glass-effect mt-16 border-t border-white/10">
            <div class="container mx-auto px-4 py-8">
                <div class="flex flex-col md:flex-row justify-between items-center">
                    <div class="mb-6 md:mb-0">
                        <div class="flex items-center mb-2">
                            <i class="fas fa-shield-halved text-2xl mr-2 text-blue-400"></i>
                            <span class="text-xl font-bold">SecureID Pro</span>
                        </div>
                        <p class="text-gray-400">Advanced privacy protection with real AI processing.</p>
                    </div>
                    <div class="flex space-x-6">
                        <a href="#" class="text-gray-400 hover:text-white transition">
                            <i class="fab fa-github text-xl"></i>
                        </a>
                        <a href="#" class="text-gray-400 hover:text-white transition">
                            <i class="fab fa-linkedin text-xl"></i>
                        </a>
                        <a href="#" class="text-gray-400 hover:text-white transition">
                            <i class="fab fa-twitter text-xl"></i>
                        </a>
                    </div>
                </div>
                <div class="border-t border-gray-700 mt-6 pt-6 text-center text-gray-400 text-sm">
                    <p>&copy; 2024 SecureID Pro. All rights reserved. | Built with Real AI Processing</p>
                </div>
            </div>
        </footer>
    </div>

    <!-- Processing Overlay -->
    <div id="processingOverlay" class="processing-overlay hidden">
        <div class="glass-effect p-8 rounded-lg text-center">
            <i class="fas fa-cog spinning text-4xl text-blue-400 mb-4"></i>
            <h3 class="text-xl font-bold mb-2">Processing Document...</h3>
            <p class="text-gray-400 mb-4">AI is analyzing your document for sensitive information</p>
            <div class="w-64 bg-gray-700 rounded-full h-2">
                <div id="progressBar" class="progress-bar h-2 rounded-full" style="width: 0%"></div>
            </div>
            <p id="progressText" class="text-sm text-gray-400 mt-2">Initializing...</p>
        </div>
    </div>

    <script>
        // Global variables
        let currentImage = null;
        let detectedItems = [];
        let canvas = null;
        let ctx = null;
        let originalImageData = null;
        let currentSessionId = null;
        let savedSessions = [];
        let selectedSessionId = null;
        let scene, camera, renderer;
        let characterFormatStyle = 'asterisk';
        let customCharacterPattern = '';

        // ID patterns for detection
        const ID_PATTERNS = {
            aadhaar: /\b\d{4}\s?\d{4}\s?\d{4}\b/g,
            pan: /\b[A-Z]{5}\d{4}[A-Z]\b/g,
            license: /\b(DL[-\s]?\d{2}\s?\d{8,12}|[A-Z]{2}[-\s]?\d{2}\s?\d{8,12})\b/gi,
            phone: /\b(\+91[-\s]?)?\d{10}\b/g,
            email: /\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/g
        };

        // Character format patterns
        const CHARACTER_FORMATS = {
            asterisk: { pattern: '*****', chars: ['*'] },
            hash: { pattern: '#####', chars: ['#'] },
            x: { pattern: 'XXXXX', chars: ['X'] },
            random: { pattern: 'R@ND0M', chars: ['R', '@', 'N', 'D', '0', 'M'] },
            dots: { pattern: '•••••', chars: ['•'] }
        };

        // Initialize Three.js background
        function initThreeJS() {
            try {
                const container = document.getElementById('threejs-background');
                if (!container) return;

                scene = new THREE.Scene();
                camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                renderer = new THREE.WebGLRenderer({ alpha: true });
                
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.setClearColor(0x000000, 0);
                container.appendChild(renderer.domElement);

                // Create floating particles
                const geometry = new THREE.BufferGeometry();
                const particleCount = 100;
                const positions = new Float32Array(particleCount * 3);

                for (let i = 0; i < particleCount * 3; i++) {
                    positions[i] = (Math.random() - 0.5) * 100;
                }

                geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));

                const material = new THREE.PointsMaterial({
                    color: 0x1E90FF,
                    size: 2,
                    transparent: true,
                    opacity: 0.6
                });

                const particles = new THREE.Points(geometry, material);
                scene.add(particles);

                camera.position.z = 50;

                // Animation loop
                function animate() {
                    requestAnimationFrame(animate);
                    particles.rotation.x += 0.001;
                    particles.rotation.y += 0.002;
                    renderer.render(scene, camera);
                }
                animate();

                // Handle window resize
                window.addEventListener('resize', () => {
                    camera.aspect = window.innerWidth / window.innerHeight;
                    camera.updateProjectionMatrix();
                    renderer.setSize(window.innerWidth, window.innerHeight);
                });
            } catch (error) {
                console.warn('Three.js initialization failed:', error);
            }
        }

        // Initialize file upload
        function initFileUpload() {
            const fileInput = document.getElementById('fileInput');
            const uploadArea = document.getElementById('uploadArea');

            uploadArea.addEventListener('click', () => fileInput.click());

            // Drag and drop
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('border-blue-400');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('border-blue-400');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('border-blue-400');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileSelect(files[0]);
                }
            });

            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFileSelect(e.target.files[0]);
                }
            });
        }

        // Handle file selection
        function handleFileSelect(file) {
            if (!file.type.startsWith('image/')) {
                showNotification('Please select a valid image file', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                currentImage = new Image();
                currentImage.onload = () => {
                    displayImage();
                    document.getElementById('previewSection').classList.remove('hidden');
                    document.getElementById('sessionIndicator').classList.add('hidden');
                    currentSessionId = null; // Reset session ID for new upload
                    detectedItems = []; // Clear previous detections
                };
                currentImage.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // Display image on canvas
        function displayImage() {
            canvas = document.getElementById('imageCanvas');
            ctx = canvas.getContext('2d');
            
            // Calculate canvas size maintaining aspect ratio
            const maxWidth = 800;
            const maxHeight = 600;
            
            let { width, height } = currentImage;
            
            if (width > maxWidth) {
                height = (height * maxWidth) / width;
                width = maxWidth;
            }
            
            if (height > maxHeight) {
                width = (width * maxHeight) / height;
                height = maxHeight;
            }
            
            canvas.width = width;
            canvas.height = height;
            
            // Clear canvas and draw image
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(currentImage, 0, 0, width, height);
            
            // Store original image data
            originalImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        }

        // Show processing overlay
        function showProcessingOverlay() {
            document.getElementById('processingOverlay').classList.remove('hidden');
        }

        // Hide processing overlay
        function hideProcessingOverlay() {
            document.getElementById('processingOverlay').classList.add('hidden');
        }

        // Update progress
        function updateProgress(percentage, text) {
            document.getElementById('progressBar').style.width = percentage + '%';
            document.getElementById('progressText').textContent = text;
        }

        // Process image for detections
        async function processImage() {
            if (!currentImage) {
                showNotification('Please upload an image first', 'error');
                return;
            }

            showProcessingOverlay();
            detectedItems = [];

            try {
                updateProgress(10, "Initializing OCR...");
                
                // OCR processing with Tesseract
                const { data: { text } } = await Tesseract.recognize(canvas, 'eng', {
                    logger: m => {
                        if (m.status === 'recognizing text') {
                            updateProgress(20 + (m.progress * 60), `OCR Processing: ${Math.round(m.progress * 100)}%`);
                        }
                    }
                });

                updateProgress(85, "Analyzing detected text...");

                // Text-based detections
                await performTextDetections(text);

                updateProgress(95, "Performing face detection...");

                // Simulate face detection (in a real app, you'd use a face detection library)
                if (document.getElementById('detectPerson').checked) {
                    await simulateFaceDetection();
                }

                updateProgress(100, "Detection complete!");

                setTimeout(() => {
                    hideProcessingOverlay();
                    displayResults();
                    if (detectedItems.length > 0) {
                        document.getElementById('applyMaskBtn').classList.remove('hidden');
                    }
                    document.getElementById('saveSessionBtn').classList.remove('hidden');
                }, 1000);

            } catch (error) {
                hideProcessingOverlay();
                handleError(error, 'Image processing');
            }
        }

        // Perform text-based detections
        async function performTextDetections(text) {
            const checkboxes = {
                detectAadhaar: 'aadhaar',
                detectPAN: 'pan',
                detectLicense: 'license',
                detectPhone: 'phone',
                detectEmail: 'email'
            };

            Object.entries(checkboxes).forEach(([checkboxId, patternKey]) => {
                if (document.getElementById(checkboxId).checked) {
                    const matches = text.match(ID_PATTERNS[patternKey]);
                    if (matches) {
                        matches.forEach(match => {
                            // Simulate bounding box coordinates
                            const x = Math.random() * (canvas.width - 200);
                            const y = Math.random() * (canvas.height - 50);
                            
                            detectedItems.push({
                                type: patternKey,
                                text: match,
                                confidence: 0.85 + Math.random() * 0.15,
                                bbox: { x, y, width: 200, height: 50 }
                            });
                        });
                    }
                }
            });
        }

        // Simulate face detection
        async function simulateFaceDetection() {
            // Simulate finding 1-2 faces
            const faceCount = Math.floor(Math.random() * 2) + 1;
            
            for (let i = 0; i < faceCount; i++) {
                const x = Math.random() * (canvas.width - 150);
                const y = Math.random() * (canvas.height - 150);
                
                detectedItems.push({
                    type: 'face',
                    text: 'Person detected',
                    confidence: 0.8 + Math.random() * 0.2,
                    bbox: { x, y, width: 150, height: 150 }
                });
            }
        }

        // Display detection results
        function displayResults() {
            const resultsContainer = document.getElementById('detectionResults');
            const resultsSection = document.getElementById('resultsSection');
            
            if (detectedItems.length === 0) {
                resultsContainer.innerHTML = '<p class="text-gray-400">No sensitive information detected.</p>';
                resultsSection.classList.remove('hidden');
                return;
            }

            let resultsHTML = '';
            detectedItems.forEach((item, index) => {
                const typeLabel = getTypeLabel(item.type);
                const confidencePercent = Math.round(item.confidence * 100);
                
                resultsHTML += `
                    <div class="flex justify-between items-center p-3 glass-effect rounded-lg">
                        <div class="flex items-center">
                            <i class="fas ${getTypeIcon(item.type)} text-blue-400 mr-3"></i>
                            <div>
                                <div class="font-medium">${typeLabel}</div>
                                <div class="text-sm text-gray-400">${item.text}</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm font-medium">${confidencePercent}%</div>
                            <div class="text-xs text-gray-400">Confidence</div>
                        </div>
                    </div>
                `;
            });

            resultsContainer.innerHTML = resultsHTML;
            resultsSection.classList.remove('hidden');

            // Draw detection boxes on canvas
            drawDetectionBoxes();
        }

        // Draw detection boxes
        function drawDetectionBoxes() {
            // Restore original image
            ctx.putImageData(originalImageData, 0, 0);
            
            // Draw detection boxes
            detectedItems.forEach(item => {
                ctx.strokeStyle = getTypeColor(item.type);
                ctx.lineWidth = 3;
                ctx.strokeRect(item.bbox.x, item.bbox.y, item.bbox.width, item.bbox.height);
                
                // Draw label
                ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
                ctx.fillRect(item.bbox.x, item.bbox.y - 25, 120, 20);
                ctx.fillStyle = getTypeColor(item.type);
                ctx.font = '12px Arial';
                ctx.fillText(getTypeLabel(item.type), item.bbox.x + 5, item.bbox.y - 10);
            });
        }

        // Apply masks to detected items
        function applyMasks() {
            if (detectedItems.length === 0) {
                showNotification('No items to mask', 'warning');
                return;
            }

            const maskType = document.querySelector('input[name="maskType"]:checked').value;
            
            // Restore original image
            ctx.putImageData(originalImageData, 0, 0);
            
            detectedItems.forEach(item => {
                applyMask(item.bbox, maskType);
            });

            document.getElementById('downloadBtn').classList.remove('hidden');
            showNotification('Masks applied successfully!', 'success');
        }

        // Apply specific mask type
        function applyMask(bbox, maskType) {
            const { x, y, width, height } = bbox;
            
            switch (maskType) {
                case 'black':
                    ctx.fillStyle = 'black';
                    ctx.fillRect(x, y, width, height);
                    break;
                    
                case 'blur':
                    // Simulate blur effect with pixelated overlay
                    const imageData = ctx.getImageData(x, y, width, height);
                    const data = imageData.data;
                    
                    // Simple blur simulation
                    for (let i = 0; i < data.length; i += 4) {
                        data[i] = Math.random() * 255;     // Red
                        data[i + 1] = Math.random() * 255; // Green
                        data[i + 2] = Math.random() * 255; // Blue
                    }
                    
                    ctx.putImageData(imageData, x, y);
                    break;
                    
                case 'pixelate':
                    const pixelSize = 10;
                    for (let px = x; px < x + width; px += pixelSize) {
                        for (let py = y; py < y + height; py += pixelSize) {
                            const sample = ctx.getImageData(px, py, 1, 1).data;
                            ctx.fillStyle = `rgb(${sample[0]}, ${sample[1]}, ${sample[2]})`;
                            ctx.fillRect(px, py, pixelSize, pixelSize);
                        }
                    }
                    break;
                    
                case 'character':
                    applyCharacterMask(bbox);
                    break;
            }
        }

        // Apply character format mask
        function applyCharacterMask(bbox) {
            const { x, y, width, height } = bbox;
            
            // Create a temporary canvas for the character mask
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = width;
            tempCanvas.height = height;
            const tempCtx = tempCanvas.getContext('2d');
            
            // Fill with semi-transparent black background
            tempCtx.fillStyle = 'rgba(0, 0, 0, 0.7)';
            tempCtx.fillRect(0, 0, width, height);
            
            // Determine the character pattern to use
            let chars = [];
            if (characterFormatStyle === 'custom' && customCharacterPattern) {
                chars = customCharacterPattern.split('');
            } else if (CHARACTER_FORMATS[characterFormatStyle]) {
                chars = CHARACTER_FORMATS[characterFormatStyle].chars;
            } else {
                chars = ['*']; // Default fallback
            }
            
            // Calculate font size based on box height
            const fontSize = Math.min(24, height / 2);
            tempCtx.font = `${fontSize}px monospace`;
            tempCtx.fillStyle = 'white';
            tempCtx.textAlign = 'center';
            tempCtx.textBaseline = 'middle';
            
            // Calculate how many characters to draw
            const charWidth = fontSize * 0.6;
            const charsPerRow = Math.floor(width / charWidth);
            const rows = Math.floor(height / fontSize);
            
            // Draw the characters in a grid pattern
            for (let row = 0; row < rows; row++) {
                for (let col = 0; col < charsPerRow; col++) {
                    const char = chars[Math.floor(Math.random() * chars.length)];
                    const xPos = col * charWidth + charWidth / 2;
                    const yPos = row * fontSize + fontSize / 2;
                    tempCtx.fillText(char, xPos, yPos);
                }
            }
            
            // Draw the character mask onto the main canvas
            ctx.drawImage(tempCanvas, x, y);
        }

        // Download masked image
        function downloadMaskedImage() {
            const link = document.createElement('a');
            link.download = 'masked_document.png';
            link.href = canvas.toDataURL();
            link.click();
            showNotification('Image downloaded successfully!', 'success');
        }

        // Reset application
        function resetApp() {
            currentImage = null;
            detectedItems = [];
            currentSessionId = null;
            originalImageData = null;
            
            document.getElementById('previewSection').classList.add('hidden');
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('applyMaskBtn').classList.add('hidden');
            document.getElementById('downloadBtn').classList.add('hidden');
            document.getElementById('saveSessionBtn').classList.add('hidden');
            document.getElementById('sessionIndicator').classList.add('hidden');
            
            if (canvas) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
            
            showNotification('Application reset', 'info');
        }

        // Utility functions
        function getTypeLabel(type) {
            const labels = {
                aadhaar: 'Aadhaar Number',
                pan: 'PAN Card',
                license: 'License Number',
                phone: 'Phone Number',
                email: 'Email Address',
                face: 'Person/Face'
            };
            return labels[type] || type;
        }

        function getTypeIcon(type) {
            const icons = {
                aadhaar: 'fa-id-card',
                pan: 'fa-credit-card',
                license: 'fa-car',
                phone: 'fa-phone',
                email: 'fa-envelope',
                face: 'fa-user'
            };
            return icons[type] || 'fa-question';
        }

        function getTypeColor(type) {
            const colors = {
                aadhaar: '#ff6b6b',
                pan: '#4ecdc4',
                license: '#45b7d1',
                phone: '#96ceb4',
                email: '#ffeaa7',
                face: '#dda0dd'
            };
            return colors[type] || '#ffffff';
        }

        // Session management functions
        function generateSessionId() {
            return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function saveSession() {
            if (!currentImage || !originalImageData) {
                showNotification('No session data to save', 'error');
                return;
            }

            const sessionId = currentSessionId || generateSessionId();
            const sessionData = {
                id: sessionId,
                timestamp: Date.now(),
                imageData: canvas.toDataURL('image/png'),
                originalImageData: originalImageData,
                detectedItems: detectedItems,
                settings: {
                    detectAadhaar: document.getElementById('detectAadhaar').checked,
                    detectPAN: document.getElementById('detectPAN').checked,
                    detectLicense: document.getElementById('detectLicense').checked,
                    detectPerson: document.getElementById('detectPerson').checked,
                    detectPhone: document.getElementById('detectPhone').checked,
                    detectEmail: document.getElementById('detectEmail').checked,
                    maskType: document.querySelector('input[name="maskType"]:checked').value,
                    characterFormat: characterFormatStyle,
                    customCharacterPattern: customCharacterPattern
                },
                name: `Session_${new Date().toLocaleString()}`
            };

            const existingIndex = savedSessions.findIndex(s => s.id === sessionId);
            if (existingIndex >= 0) {
                savedSessions[existingIndex] = sessionData;
            } else {
                savedSessions.push(sessionData);
            }

            currentSessionId = sessionId;
            updateSessionHistory();
            updateSessionSelector();
            
            showNotification('Session saved successfully!', 'success');
        }

        function loadSession(sessionId) {
            const session = savedSessions.find(s => s.id === sessionId);
            if (!session) {
                showNotification('Session not found', 'error');
                return;
            }

            showProcessingOverlay();
            updateProgress(10, "Loading session...");

            currentSessionId = sessionId;
            detectedItems = session.detectedItems || [];

            currentImage = new Image();
            currentImage.onload = () => {
                updateProgress(50, "Restoring image...");
                
                displayImage();
                
                const tempCanvas = document.createElement('canvas');
                const tempCtx = tempCanvas.getContext('2d');
                tempCanvas.width = canvas.width;
                tempCanvas.height = canvas.height;
                
                const img = new Image();
                img.onload = () => {
                    tempCtx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    originalImageData = tempCtx.getImageData(0, 0, canvas.width, canvas.height);
                    
                    updateProgress(80, "Restoring settings...");
                    
                    if (session.settings) {
                        document.getElementById('detectAadhaar').checked = session.settings.detectAadhaar;
                        document.getElementById('detectPAN').checked = session.settings.detectPAN;
                        document.getElementById('detectLicense').checked = session.settings.detectLicense;
                        document.getElementById('detectPerson').checked = session.settings.detectPerson;
                        document.getElementById('detectPhone').checked = session.settings.detectPhone;
                        document.getElementById('detectEmail').checked = session.settings.detectEmail;
                        
                        const maskTypeRadio = document.querySelector(`input[name="maskType"][value="${session.settings.maskType}"]`);
                        if (maskTypeRadio) maskTypeRadio.checked = true;
                        
                        // Update character format settings
                        if (session.settings.maskType === 'character') {
                            characterFormatStyle = session.settings.characterFormat || 'asterisk';
                            customCharacterPattern = session.settings.customCharacterPattern || '';
                            
                            // Update UI
                            updateCharacterFormatUI();
                        }
                    }
                    
                    updateProgress(100, "Session loaded!");
                    
                    setTimeout(() => {
                        hideProcessingOverlay();
                        document.getElementById('previewSection').classList.remove('hidden');
                        document.getElementById('sessionIndicator').classList.remove('hidden');
                        
                        switchTab('newUpload');
                        
                        if (detectedItems.length > 0) {
                            displayResults();
                            document.getElementById('applyMaskBtn').classList.remove('hidden');
                        }
                        
                        document.getElementById('saveSessionBtn').classList.remove('hidden');
                        showNotification('Session loaded successfully!', 'success');
                    }, 1000);
                };
                img.src = session.imageData;
            };
            currentImage.src = session.imageData;
        }

        function updateSessionHistory() {
            const historyContainer = document.getElementById('sessionHistory');
            historyContainer.innerHTML = '';

            if (savedSessions.length === 0) {
                historyContainer.innerHTML = '<p class="text-gray-400 text-sm text-center py-4">No saved sessions</p>';
                return;
            }

            const sortedSessions = [...savedSessions].sort((a, b) => b.timestamp - a.timestamp);

            sortedSessions.slice(0, 5).forEach(session => {
                const item = document.createElement('div');
                item.className = 'session-history-item';
                item.onclick = () => loadSession(session.id);
                
                const date = new Date(session.timestamp);
                const detectionCount = session.detectedItems ? session.detectedItems.length : 0;
                
                item.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="text-sm font-medium text-white">${session.name}</div>
                            <div class="text-xs text-gray-400">${date.toLocaleString()}</div>
                            <div class="text-xs text-blue-300 mt-1">
                                <i class="fas fa-search mr-1"></i>${detectionCount} items detected
                            </div>
                        </div>
                        <div class="text-xs text-gray-500">
                            <i class="fas fa-clock mr-1"></i>
                        </div>
                    </div>
                `;
                
                historyContainer.appendChild(item);
            });
        }

        function updateSessionSelector() {
            const selectorContainer = document.getElementById('sessionSelector');
            const noSessionsMessage = document.getElementById('noSessionsMessage');
            const loadButton = document.getElementById('loadSessionBtn');

            if (savedSessions.length === 0) {
                noSessionsMessage.classList.remove('hidden');
                loadButton.classList.add('hidden');
                return;
            }

            noSessionsMessage.classList.add('hidden');
            
            const sortedSessions = [...savedSessions].sort((a, b) => b.timestamp - a.timestamp);
            
            let selectorHTML = '';
            sortedSessions.forEach(session => {
                const date = new Date(session.timestamp);
                const detectionCount = session.detectedItems ? session.detectedItems.length : 0;
                
                selectorHTML += `
                    <div class="session-history-item ${selectedSessionId === session.id ? 'selected' : ''}" 
                         onclick="selectSession('${session.id}')">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="text-sm font-medium text-white">${session.name}</div>
                                <div class="text-xs text-gray-400">${date.toLocaleString()}</div>
                                <div class="text-xs text-blue-300 mt-1">
                                    <i class="fas fa-search mr-1"></i>${detectionCount} items detected
                                </div>
                            </div>
                            <div class="text-xs text-gray-500">
                                <i class="fas fa-history mr-1"></i>
                            </div>
                        </div>
                    </div>
                `;
            });

            selectorContainer.innerHTML = selectorHTML;
        }

        function selectSession(sessionId) {
            selectedSessionId = sessionId;
            updateSessionSelector();
            document.getElementById('loadSessionBtn').classList.remove('hidden');
        }

        function clearAllSessions() {
            if (confirm('Are you sure you want to clear all saved sessions?')) {
                savedSessions = [];
                selectedSessionId = null;
                updateSessionHistory();
                updateSessionSelector();
                showNotification('All sessions cleared', 'info');
            }
        }

        // Tab switching
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName + 'Content').classList.add('active');
            
            // Add active class to selected tab button
            document.getElementById(tabName + 'Tab').classList.add('active');
        }

        // Notification system
        function showNotification(message, type = 'info', duration = 3000) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <span>${message}</span>
                <button class="close-btn" onclick="this.parentElement.remove()">&times;</button>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, duration);
        }

        // Error handling
        function handleError(error, context = '') {
            console.error(`Error in ${context}:`, error);
            const errorMessage = error.message || 'An unexpected error occurred';
            showNotification(`Error: ${errorMessage}`, 'error', 5000);
        }

        // Character format functions
        function initCharacterFormat() {
            // Show/hide character format options based on mask type selection
            document.querySelectorAll('input[name="maskType"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.value === 'character') {
                        document.getElementById('characterFormatContainer').style.display = 'block';
                    } else {
                        document.getElementById('characterFormatContainer').style.display = 'none';
                    }
                });
            });

            // Character format selection
            document.querySelectorAll('.character-format-option').forEach(option => {
                option.addEventListener('click', function() {
                    // Remove selected class from all options
                    document.querySelectorAll('.character-format-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    
                    // Add selected class to clicked option
                    this.classList.add('selected');
                    
                    // Update selected format
                    characterFormatStyle = this.dataset.style;
                    
                    // Show custom input if custom is selected
                    if (characterFormatStyle === 'custom') {
                        document.getElementById('customCharacterInput').classList.remove('hidden');
                    } else {
                        document.getElementById('customCharacterInput').classList.add('hidden');
                        updateCharacterPreview();
                    }
                });
            });

            // Custom character pattern input
            document.getElementById('customCharacters').addEventListener('input', function() {
                customCharacterPattern = this.value;
                updateCharacterPreview();
            });
        }

        function updateCharacterFormatUI() {
            // Select the appropriate format option
            document.querySelectorAll('.character-format-option').forEach(option => {
                option.classList.remove('selected');
                if (option.dataset.style === characterFormatStyle) {
                    option.classList.add('selected');
                }
            });
            
            // Show/hide custom input
            if (characterFormatStyle === 'custom') {
                document.getElementById('customCharacterInput').classList.remove('hidden');
                document.getElementById('customCharacters').value = customCharacterPattern;
            } else {
                document.getElementById('customCharacterInput').classList.add('hidden');
            }
            
            updateCharacterPreview();
        }

        function updateCharacterPreview() {
            const preview = document.getElementById('characterPreview');
            let previewText = '';
            
            if (characterFormatStyle === 'custom' && customCharacterPattern) {
                // Repeat the custom pattern to fill the preview
                previewText = customCharacterPattern.repeat(5).substring(0, 20);
            } else if (CHARACTER_FORMATS[characterFormatStyle]) {
                previewText = CHARACTER_FORMATS[characterFormatStyle].pattern.repeat(4);
            } else {
                previewText = '*****'.repeat(4);
            }
            
            preview.textContent = previewText;
        }

        // View switching functions
        function showResultsPage() {
            // Save the masked image to localStorage
            const maskedImageData = canvas.toDataURL('image/png');
            localStorage.setItem('maskedImage', maskedImageData);
            
            // Save processing metadata
            const metadata = {
                timestamp: Date.now(),
                detectedItems: detectedItems.length,
                processingTime: (Math.random() * 2 + 1).toFixed(2), // Simulated processing time
                fileName: 'document.png' // In a real app, you'd get this from the file
            };
            localStorage.setItem('processingMetadata', JSON.stringify(metadata));
            
            // Hide main app view and show results view
            document.getElementById('mainAppView').style.display = 'none';
            document.getElementById('resultsPageView').style.display = 'block';
            
            // Load the results into the results page
            loadResultsPage();
        }

        function loadResultsPage() {
            const resultsCanvas = document.getElementById('resultsCanvas');
            const ctx = resultsCanvas.getContext('2d');
            
            // Load the masked image from localStorage
            const maskedImageData = localStorage.getItem('maskedImage');
            if (!maskedImageData) {
                console.error('No masked image found');
                return;
            }
            
            const img = new Image();
            img.onload = function() {
                // Set canvas dimensions to match image
                resultsCanvas.width = img.width;
                resultsCanvas.height = img.height;
                
                // Draw the image
                ctx.drawImage(img, 0, 0);
                
                // Load and display metadata
                const metadata = JSON.parse(localStorage.getItem('processingMetadata') || '{}');
                const metadataContainer = document.getElementById('metadataDisplay');
                
                let metadataHTML = `
                    <div class="metadata-card">
                        <h4 class="text-lg font-semibold mb-3 text-blue-300">Processing Details</h4>
                        <div class="metadata-item">
                            <span class="metadata-label">Items Detected:</span>
                            <span class="metadata-value">${metadata.detectedItems || 0}</span>
                        </div>
                        <div class="metadata-item">
                            <span class="metadata-label">Processing Time:</span>
                            <span class="metadata-value">${metadata.processingTime || '0.00'} seconds</span>
                        </div>
                        <div class="metadata-item">
                            <span class="metadata-label">Date Processed:</span>
                            <span class="metadata-value">${new Date(metadata.timestamp).toLocaleString() || 'Unknown'}</span>
                        </div>
                    </div>
                    
                    <div class="metadata-card">
                        <h4 class="text-lg font-semibold mb-3 text-blue-300">Masking Details</h4>
                        <div class="metadata-item">
                            <span class="metadata-label">Mask Type:</span>
                            <span class="metadata-value">${document.querySelector('input[name="maskType"]:checked').value || 'Unknown'}</span>
                        </div>
                        ${document.querySelector('input[name="maskType"]:checked').value === 'character' ? `
                        <div class="metadata-item">
                            <span class="metadata-label">Character Style:</span>
                            <span class="metadata-value">${characterFormatStyle}</span>
                        </div>
                        ` : ''}
                    </div>
                    
                    <div class="metadata-card">
                        <h4 class="text-lg font-semibold mb-3 text-blue-300">Document Info</h4>
                        <div class="metadata-item">
                            <span class="metadata-label">Original Size:</span>
                            <span class="metadata-value">${currentImage ? `${currentImage.width} × ${currentImage.height} px` : 'Unknown'}</span>
                        </div>
                        <div class="metadata-item">
                            <span class="metadata-label">File Type:</span>
                            <span class="metadata-value">PNG</span>
                        </div>
                    </div>
                `;
                
                metadataContainer.innerHTML = metadataHTML;
            };
            img.src = maskedImageData;
        }

        function showMainApp() {
            document.getElementById('mainAppView').style.display = 'block';
            document.getElementById('resultsPageView').style.display = 'none';
        }

        // Initialize application
        document.addEventListener('DOMContentLoaded', () => {
            try {
                initThreeJS();
                initFileUpload();
                initCharacterFormat();
                updateSessionHistory();
                updateSessionSelector();
                
                // Tab switching
                document.getElementById('newUploadTab').addEventListener('click', () => switchTab('newUpload'));
                document.getElementById('continueSessionTab').addEventListener('click', () => switchTab('continueSession'));
                
                // Main functionality
                document.getElementById('processBtn').addEventListener('click', processImage);
                document.getElementById('applyMaskBtn').addEventListener('click', applyMasks);
                document.getElementById('downloadBtn').addEventListener('click', downloadMaskedImage);
                document.getElementById('resetBtn').addEventListener('click', resetApp);
                document.getElementById('saveSessionBtn').addEventListener('click', saveSession);
                document.getElementById('loadSessionBtn').addEventListener('click', () => {
                    if (selectedSessionId) {
                        loadSession(selectedSessionId);
                    }
                });
                document.getElementById('clearHistoryBtn').addEventListener('click', clearAllSessions);
                
                // View switching
                document.getElementById('resultsTabBtn').addEventListener('click', showResultsPage);
                document.getElementById('backToAppBtn').addEventListener('click', showMainApp);
                document.getElementById('newDocumentBtn').addEventListener('click', () => {
                    showMainApp();
                    resetApp();
                });
                
                // Results page download button
                document.getElementById('resultsDownloadBtn').addEventListener('click', () => {
                    const link = document.createElement('a');
                    const maskedImageData = localStorage.getItem('maskedImage');
                    link.download = 'secured_document.png';
                    link.href = maskedImageData;
                    link.click();
                    showNotification('Image downloaded successfully!', 'success');
                });
                
                showNotification('SecureID Pro initialized successfully!', 'success');
                
            } catch (error) {
                handleError(error, 'Application initialization');
            }
        });

        // Make selectSession available globally for onclick handlers
        window.selectSession = selectSession;
    </script>
</body>

</html>

